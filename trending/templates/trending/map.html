{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="p-3">
  <div class="container">
    <h1 class="mb-4">{{ template_data.title }}</h1>
    
    {% if user.is_authenticated %}
      <div class="alert alert-info d-flex justify-content-between align-items-center">
        <div>
          <strong>Your Region:</strong> 
          {% if template_data.user_region %}
            {% if template_data.user_region == 'northeast' %}Northeast
            {% elif template_data.user_region == 'southeast' %}Southeast
            {% elif template_data.user_region == 'midwest' %}Midwest
            {% elif template_data.user_region == 'southwest' %}Southwest
            {% elif template_data.user_region == 'west' %}West
            {% endif %}
          {% else %}
            Not set (Default: Northeast)
          {% endif %}
        </div>
        <a href="{% url 'accounts.update_region' %}" class="btn btn-primary btn-sm">
          <i class="fas fa-edit"></i> Change Region
        </a>
      </div>
    {% else %}
      <div class="alert alert-warning">
        <a href="{% url 'accounts.login' %}">Log in</a> to see trending movies in your region
      </div>
    {% endif %}

    <!-- US Map Visualization -->
    <div class="row mb-5">
      <div class="col-12">
        <div class="card shadow">
          <div class="card-body">
            <h3 class="card-title text-center mb-4">Regional Trending Movies Map</h3>
            <div id="map-container" style="position: relative; height: 600px; border: 2px solid #dee2e6; border-radius: 10px; overflow: hidden;">
              <!-- US Map Background Image -->
              <img src="{% static 'img/united-states.jpg' %}" alt="United States Map" 
                   style="width: 100%; height: 100%; object-fit: contain; position: absolute; top: 0; left: 0;">
              
              <!-- Interactive SVG Overlay -->
              <svg width="100%" height="100%" viewBox="0 0 1000 600" preserveAspectRatio="xMidYMid meet" style="position: absolute; top: 0; left: 0;">
                <!-- West Region - Expanded to cover entire west coast and mountain states -->
                <g id="west-region" class="region-group" data-region="west" style="cursor: pointer;">
                  <polygon points="50,70 220,60 290,90 350,130 390,190 400,250 390,310 350,360 310,400 270,440 220,480 170,510 120,510 70,480 40,430 30,370 30,320 40,270 50,220 55,170 50,120" 
                           fill="{{ template_data.regions_data.west.info.color }}" 
                           opacity="0.5" 
                           stroke="#fff" 
                           stroke-width="3"/>
                  <text x="230" y="320" text-anchor="middle" font-size="28" font-weight="bold" fill="#fff" stroke="#000" stroke-width="0.5">
                    West
                  </text>
                  <text x="230" y="355" text-anchor="middle" font-size="18" fill="#fff" stroke="#000" stroke-width="0.3">
                    {% with template_data.regional_trending.west.movies|length as count %}
                      {{ count }} trending
                    {% endwith %}
                  </text>
                </g>

                <!-- Southwest Region - Expanded to cover TX, OK, NM, AZ -->
                <g id="southwest-region" class="region-group" data-region="southwest" style="cursor: pointer;">
                  <polygon points="340,430 420,380 480,360 540,380 590,420 610,480 600,530 560,560 500,570 440,560 380,540 340,510 310,470" 
                           fill="{{ template_data.regions_data.southwest.info.color }}" 
                           opacity="0.5" 
                           stroke="#fff" 
                           stroke-width="3"/>
                  <text x="470" y="460" text-anchor="middle" font-size="28" font-weight="bold" fill="#fff" stroke="#000" stroke-width="0.5">
                    Southwest
                  </text>
                  <text x="470" y="495" text-anchor="middle" font-size="18" fill="#fff" stroke="#000" stroke-width="0.3">
                    {% with template_data.regional_trending.southwest.movies|length as count %}
                      {{ count }} trending
                    {% endwith %}
                  </text>
                </g>

                <!-- Midwest Region - Expanded to cover entire central region -->
                <g id="midwest-region" class="region-group" data-region="midwest" style="cursor: pointer;">
                  <polygon points="420,220 480,200 550,190 620,200 680,230 710,270 720,320 710,370 680,400 640,420 590,420 540,410 480,400 440,380 420,340 410,280" 
                           fill="{{ template_data.regions_data.midwest.info.color }}" 
                           opacity="0.5" 
                           stroke="#fff" 
                           stroke-width="3"/>
                  <text x="570" y="290" text-anchor="middle" font-size="28" font-weight="bold" fill="#fff" stroke="#000" stroke-width="0.5">
                    Midwest
                  </text>
                  <text x="570" y="325" text-anchor="middle" font-size="18" fill="#fff" stroke="#000" stroke-width="0.3">
                    {% with template_data.regional_trending.midwest.movies|length as count %}
                      {{ count }} trending
                    {% endwith %}
                  </text>
                </g>

                <!-- Southeast Region - Expanded to cover all southern states -->
                <g id="southeast-region" class="region-group" data-region="southeast" style="cursor: pointer;">
                  <polygon points="610,420 680,400 750,410 820,440 880,480 920,520 920,560 880,570 820,575 760,570 700,565 640,555 590,540 560,510 540,470 540,440 570,420" 
                           fill="{{ template_data.regions_data.southeast.info.color }}" 
                           opacity="0.5" 
                           stroke="#fff" 
                           stroke-width="3"/>
                  <text x="730" y="490" text-anchor="middle" font-size="28" font-weight="bold" fill="#fff" stroke="#000" stroke-width="0.5">
                    Southeast
                  </text>
                  <text x="730" y="525" text-anchor="middle" font-size="18" fill="#fff" stroke="#000" stroke-width="0.3">
                    {% with template_data.regional_trending.southeast.movies|length as count %}
                      {{ count }} trending
                    {% endwith %}
                  </text>
                </g>

                <!-- Northeast Region - Expanded to cover all northeastern states -->
                <g id="northeast-region" class="region-group" data-region="northeast" style="cursor: pointer;">
                  <polygon points="680,230 750,210 820,210 880,230 930,260 950,300 950,340 930,370 890,390 840,400 780,400 720,390 680,370 660,330 660,280 670,250" 
                           fill="{{ template_data.regions_data.northeast.info.color }}" 
                           opacity="0.5" 
                           stroke="#fff" 
                           stroke-width="3"/>
                  <text x="810" y="290" text-anchor="middle" font-size="28" font-weight="bold" fill="#fff" stroke="#000" stroke-width="0.5">
                    Northeast
                  </text>
                  <text x="810" y="325" text-anchor="middle" font-size="18" fill="#fff" stroke="#000" stroke-width="0.3">
                    {% with template_data.regional_trending.northeast.movies|length as count %}
                      {{ count }} trending
                    {% endwith %}
                  </text>
                </g>
              </svg>
              
              <div class="text-center mt-3">
                <small class="text-muted">Click on a region to see trending movies</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Regional Details (Hidden by default, shown when region is selected) -->
    {% for region_code, region_data in template_data.regional_trending.items %}
    <div id="region-{{ region_code }}" class="region-details" style="display: none;">
      <div class="card shadow mb-4">
        <div class="card-header" style="background-color: {{ region_data.info.color }}; color: white;">
          <h3 class="mb-0">
            <i class="bi bi-fire"></i> Trending in {{ region_data.info.name }}
          </h3>
        </div>
        <div class="card-body">
          {% if region_data.movies %}
            <div class="row">
              {% for movie in region_data.movies %}
              <div class="col-md-6 col-lg-4 mb-3">
                <div class="card h-100">
                  <div class="card-body">
                    <h5 class="card-title">{{ movie.movie__name }}</h5>
                    <p class="card-text">
                      <strong>Total Purchases:</strong> {{ movie.total_purchases }}<br>
                      <strong>Orders:</strong> {{ movie.order_count }}
                    </p>
                    <a href="{% url 'movies.show' id=movie.movie__id %}" class="btn btn-primary btn-sm">
                      View Movie
                    </a>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="alert alert-info">
              <p class="mb-0">No purchases recorded in this region yet.</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}

    <!-- Overall Trending Movies -->
    <div class="row mt-5">
      <div class="col-12">
        <div class="card shadow">
          <div class="card-header bg-dark text-white">
            <h3 class="mb-0"><i class="bi bi-trophy"></i> Top Trending Movies Nationwide</h3>
          </div>
          <div class="card-body">
            {% if template_data.overall_trending %}
              <div class="table-responsive">
                <table class="table table-striped table-hover">
                  <thead>
                    <tr>
                      <th>Rank</th>
                      <th>Movie</th>
                      <th>Total Purchases</th>
                      <th>Orders</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for movie in template_data.overall_trending %}
                    <tr>
                      <td><strong>#{{ forloop.counter }}</strong></td>
                      <td>{{ movie.movie__name }}</td>
                      <td><span class="badge bg-success">{{ movie.total_purchases }}</span></td>
                      <td>{{ movie.order_count }}</td>
                      <td>
                        <a href="{% url 'movies.show' id=movie.movie__id %}" class="btn btn-sm btn-primary">
                          View
                        </a>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="alert alert-info">
                <p class="mb-0">No movie purchases recorded yet.</p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Region selection functionality
document.addEventListener('DOMContentLoaded', function() {
  const regionGroups = document.querySelectorAll('.region-group');
  const regionDetails = document.querySelectorAll('.region-details');
  
  regionGroups.forEach(group => {
    group.addEventListener('click', function() {
      const regionCode = this.getAttribute('data-region');
      
      // Hide all region details
      regionDetails.forEach(detail => {
        detail.style.display = 'none';
      });
      
      // Reset all regions to default opacity
      regionGroups.forEach(g => {
        g.querySelector('polygon').setAttribute('opacity', '0.6');
      });
      
      // Show selected region details
      const selectedDetail = document.getElementById('region-' + regionCode);
      if (selectedDetail) {
        selectedDetail.style.display = 'block';
        this.querySelector('polygon').setAttribute('opacity', '0.9');
        
        // Scroll to the details
        selectedDetail.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    });
    
    // Hover effect
    group.addEventListener('mouseenter', function() {
      this.querySelector('polygon').setAttribute('opacity', '0.8');
    });
    
    group.addEventListener('mouseleave', function() {
      const currentOpacity = this.querySelector('polygon').getAttribute('opacity');
      if (currentOpacity !== '0.9') {
        this.querySelector('polygon').setAttribute('opacity', '0.6');
      }
    });
  });
});
</script>

<style>
.region-group {
  transition: all 0.3s ease;
}

.region-group:hover polygon {
  filter: brightness(1.1);
}
</style>
{% endblock content %}
